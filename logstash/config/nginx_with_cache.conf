input {
	tcp {
		type => "nginx_with_cache"
		port => 5000
	}
}

filter {
	if [type] == "nginx_with_cache" {
		grok {
			match => { 
				"message" => "%{IPORHOST:remote_addr} %{USERNAME:remote_user} - \[%{HTTPDATE:time_local}\] \"%{WORD:verb} %{NOTSPACE:request} HTTP/%{NUMBER:httpversion}\" %{INT:status} %{INT:body_bytes_sent:int} %{QS:http_referer};? %{QS:http_user_agent} upstream_addr=\"%{NOTSPACE:upstream_addr}\" upstream_status=\"%{NOTSPACE:upstream_status}\" upstream_responsse_time=\"%{NOTSPACE:upstream_response_time}\" cache=\"%{NOTSPACE:upstream_cache_status}\""	
			}
		}
		date {
			match => [ "time_local" , "dd/MMM/YYYY:HH:mm:ss Z" ]
		}
		if [upstream_response_time] == "-" {
			mutate { remove_field => ["upstream_response_time"] }
		}
		#geoip {
		#	source => "[remote_addr]"
		#}
	}
}

output {
	stdout {
		codec => rubydebug
	}
	elasticsearch {
		hosts => ["elasticsearch:9200"]
	}
}
